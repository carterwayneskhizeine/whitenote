<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhiteNote API æµ‹è¯•</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #333; margin-bottom: 20px; }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section h2 {
      color: #555;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: 500;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    textarea {
      min-height: 100px;
      font-family: monospace;
    }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover { background: #0051cc; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .response {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .response.error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    .response.success {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .user-info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .loading {
      display: inline-block;
      margin-left: 10px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª WhiteNote Messages API æµ‹è¯•</h1>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ‘¤ å½“å‰ç”¨æˆ·</h2>
      <div id="userInfo" class="user-info">åŠ è½½ä¸­...</div>
      <button onclick="fetchUserInfo()">åˆ·æ–°ç”¨æˆ·ä¿¡æ¯</button>
      <button onclick="window.location.href='/login'" id="loginBtn">å»ç™»å½•</button>
    </div>

    <!-- 1. åˆ›å»ºæ¶ˆæ¯ -->
    <div class="section">
      <h2>ğŸ“ 1. åˆ›å»ºæ¶ˆæ¯ (POST /api/messages)</h2>
      <div class="form-group">
        <label>å†…å®¹ (content)</label>
        <textarea id="createContent">Hello WhiteNote! This is a test message.</textarea>
      </div>
      <div class="form-group">
        <label>æ ‡ç­¾ (tags, é€—å·åˆ†éš”)</label>
        <input type="text" id="createTags" value="test,api,first">
      </div>
      <button onclick="createMessage()">åˆ›å»ºæ¶ˆæ¯</button>
      <div id="createResponse" class="response" style="display:none"></div>
    </div>

    <!-- 2. è·å–æ¶ˆæ¯åˆ—è¡¨ -->
    <div class="section">
      <h2>ğŸ“‹ 2. è·å–æ¶ˆæ¯åˆ—è¡¨ (GET /api/messages)</h2>
      <div class="form-group">
        <label>æŸ¥è¯¢å‚æ•°</label>
        <input type="text" id="listParams" placeholder="ä¾‹å¦‚: ?tagId=xxx&isStarred=true&page=1&limit=10">
      </div>
      <button onclick="fetchMessages()">è·å–æ¶ˆæ¯åˆ—è¡¨</button>
      <div id="listResponse" class="response" style="display:none"></div>
    </div>

    <!-- 3. è·å–å•æ¡æ¶ˆæ¯ -->
    <div class="section">
      <h2>ğŸ” 3. è·å–å•æ¡æ¶ˆæ¯ (GET /api/messages/[id])</h2>
      <div class="form-group">
        <label>æ¶ˆæ¯ ID</label>
        <input type="text" id="getMessageId" placeholder="è¾“å…¥æ¶ˆæ¯ ID">
      </div>
      <button onclick="fetchMessage()">è·å–æ¶ˆæ¯è¯¦æƒ…</button>
      <div id="getMessageResponse" class="response" style="display:none"></div>
    </div>

    <!-- 4. æ›´æ–°æ¶ˆæ¯ -->
    <div class="section">
      <h2>âœï¸ 4. æ›´æ–°æ¶ˆæ¯ (PUT /api/messages/[id])</h2>
      <div class="form-group">
        <label>æ¶ˆæ¯ ID</label>
        <input type="text" id="updateMessageId" placeholder="è¾“å…¥æ¶ˆæ¯ ID">
      </div>
      <div class="form-group">
        <label>æ–°å†…å®¹</label>
        <textarea id="updateContent">Updated content...</textarea>
      </div>
      <button onclick="updateMessage()">æ›´æ–°æ¶ˆæ¯</button>
      <div id="updateResponse" class="response" style="display:none"></div>
    </div>

    <!-- 5. æ”¶è—/å–æ¶ˆæ”¶è— -->
    <div class="section">
      <h2>â­ 5. åˆ‡æ¢æ”¶è—çŠ¶æ€ (POST /api/messages/[id]/star)</h2>
      <div class="form-group">
        <label>æ¶ˆæ¯ ID</label>
        <input type="text" id="starMessageId" placeholder="è¾“å…¥æ¶ˆæ¯ ID">
      </div>
      <button onclick="toggleStar()">åˆ‡æ¢æ”¶è—</button>
      <div id="starResponse" class="response" style="display:none"></div>
    </div>

    <!-- 6. ç½®é¡¶/å–æ¶ˆç½®é¡¶ -->
    <div class="section">
      <h2>ğŸ“Œ 6. åˆ‡æ¢ç½®é¡¶çŠ¶æ€ (POST /api/messages/[id]/pin)</h2>
      <div class="form-group">
        <label>æ¶ˆæ¯ ID</label>
        <input type="text" id="pinMessageId" placeholder="è¾“å…¥æ¶ˆæ¯ ID">
      </div>
      <button onclick="togglePin()">åˆ‡æ¢ç½®é¡¶</button>
      <div id="pinResponse" class="response" style="display:none"></div>
    </div>

    <!-- 7. åˆ é™¤æ¶ˆæ¯ -->
    <div class="section">
      <h2>ğŸ—‘ï¸ 7. åˆ é™¤æ¶ˆæ¯ (DELETE /api/messages/[id])</h2>
      <div class="form-group">
        <label>æ¶ˆæ¯ ID</label>
        <input type="text" id="deleteMessageId" placeholder="è¾“å…¥æ¶ˆæ¯ ID">
      </div>
      <button onclick="deleteMessage()" style="background: #dc3545;">åˆ é™¤æ¶ˆæ¯</button>
      <div id="deleteResponse" class="response" style="display:none"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';

    // æ˜¾ç¤ºå“åº”
    function showResponse(elementId, data, isSuccess) {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      el.className = 'response ' + (isSuccess ? 'success' : 'error');
      el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    async function fetchUserInfo() {
      try {
        const res = await fetch(`${API_BASE}/auth/me`);
        const data = await res.json();

        if (res.ok) {
          document.getElementById('userInfo').innerHTML = `
            <strong>âœ… å·²ç™»å½•</strong><br>
            ID: ${data.data.id}<br>
            Email: ${data.data.email}<br>
            Name: ${data.data.name || 'N/A'}
          `;
          document.getElementById('loginBtn').style.display = 'none';
        } else {
          document.getElementById('userInfo').innerHTML = `<strong>âŒ æœªç™»å½•</strong><br>${data.error}`;
          document.getElementById('loginBtn').style.display = 'inline-block';
        }
      } catch (error) {
        document.getElementById('userInfo').innerHTML = `<strong>âŒ é”™è¯¯</strong><br>${error.message}`;
      }
    }

    // 1. åˆ›å»ºæ¶ˆæ¯
    async function createMessage() {
      const content = document.getElementById('createContent').value;
      const tagsInput = document.getElementById('createTags').value;
      const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

      try {
        const res = await fetch(`${API_BASE}/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content, tags }),
        });

        const data = await res.json();
        showResponse('createResponse', data, res.ok);

        if (res.ok && data.data.id) {
          // è‡ªåŠ¨å¡«å…… ID åˆ°å…¶ä»–è¡¨å•
          const id = data.data.id;
          document.getElementById('getMessageId').value = id;
          document.getElementById('updateMessageId').value = id;
          document.getElementById('starMessageId').value = id;
          document.getElementById('pinMessageId').value = id;
          document.getElementById('deleteMessageId').value = id;
        }
      } catch (error) {
        showResponse('createResponse', error.message, false);
      }
    }

    // 2. è·å–æ¶ˆæ¯åˆ—è¡¨
    async function fetchMessages() {
      const params = document.getElementById('listParams').value;

      try {
        const res = await fetch(`${API_BASE}/messages${params}`);
        const data = await res.json();
        showResponse('listResponse', data, res.ok);
      } catch (error) {
        showResponse('listResponse', error.message, false);
      }
    }

    // 3. è·å–å•æ¡æ¶ˆæ¯
    async function fetchMessage() {
      const id = document.getElementById('getMessageId').value;

      if (!id) {
        showResponse('getMessageResponse', 'è¯·è¾“å…¥æ¶ˆæ¯ ID', false);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/messages/${id}`);
        const data = await res.json();
        showResponse('getMessageResponse', data, res.ok);
      } catch (error) {
        showResponse('getMessageResponse', error.message, false);
      }
    }

    // 4. æ›´æ–°æ¶ˆæ¯
    async function updateMessage() {
      const id = document.getElementById('updateMessageId').value;
      const content = document.getElementById('updateContent').value;

      if (!id) {
        showResponse('updateResponse', 'è¯·è¾“å…¥æ¶ˆæ¯ ID', false);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/messages/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content }),
        });

        const data = await res.json();
        showResponse('updateResponse', data, res.ok);
      } catch (error) {
        showResponse('updateResponse', error.message, false);
      }
    }

    // 5. åˆ‡æ¢æ”¶è—
    async function toggleStar() {
      const id = document.getElementById('starMessageId').value;

      if (!id) {
        showResponse('starResponse', 'è¯·è¾“å…¥æ¶ˆæ¯ ID', false);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/messages/${id}/star`, {
          method: 'POST',
        });
        const data = await res.json();
        showResponse('starResponse', data, res.ok);
      } catch (error) {
        showResponse('starResponse', error.message, false);
      }
    }

    // 6. åˆ‡æ¢ç½®é¡¶
    async function togglePin() {
      const id = document.getElementById('pinMessageId').value;

      if (!id) {
        showResponse('pinResponse', 'è¯·è¾“å…¥æ¶ˆæ¯ ID', false);
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/messages/${id}/pin`, {
          method: 'POST',
        });
        const data = await res.json();
        showResponse('pinResponse', data, res.ok);
      } catch (error) {
        showResponse('pinResponse', error.message, false);
      }
    }

    // 7. åˆ é™¤æ¶ˆæ¯
    async function deleteMessage() {
      const id = document.getElementById('deleteMessageId').value;

      if (!id) {
        showResponse('deleteResponse', 'è¯·è¾“å…¥æ¶ˆæ¯ ID', false);
        return;
      }

      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/messages/${id}`, {
          method: 'DELETE',
        });
        const data = await res.json();
        showResponse('deleteResponse', data, res.ok);
      } catch (error) {
        showResponse('deleteResponse', error.message, false);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
    fetchUserInfo();
  </script>
</body>
</html>
